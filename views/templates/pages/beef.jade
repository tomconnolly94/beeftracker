extends ../layouts/layout.jade
include ../components/trending_beef/trending_beef.jade
include ../components/timeline/timeline.jade
include ../components/related_beef/related_beef.jade
include ../components/comment_box/comment_box.jade
include ../components/voting_panel/voting_panel.jade
include ../layouts/section.jade
include ../layouts/masonry_gallery.jade
include ../components/google_adsense/adsense_banner_ad.jade
include ../template_helper_functions/file_server_url_builder.jade

append scripts
    script(src="/bower_components/shufflejs/dist/shuffle.js")
    script(src="/bower_components/fancybox/dist/jquery.fancybox.js" async)
    script(src="/bower_components/select2/dist/js/select2.full.js")

append body_scripts
    +masonry-gallery-script()
    +timeline-section-js()
    script.
        //Associated Actors
        function formatState (state) {
            if (!state.id || state.element.getAttribute('disabled')) {
                return state.text;
            }
            var $state = $(
                '<span><img style="width: 48px;" src="'+state.element.getAttribute('image_src') + '" class="img-flag" /> ' + state.text + '</span>'
            );
            return $state;
        };

        function handle_also_appears_in_select(element){
            window.location = element.value + window.location.pathname.split("/").pop();
        }

        //Also appears in selector
        var aaisEl = $(".also-appears-in-select");
        aaisEl.select2({
            placeholder: "Event also appears in...",
            templateResult: formatState,
            theme: 'classic',
            width: "100%",
            minimumResultsForSearch: -1 //Disable search
        });
        
        aaisEl.on('select2:select', function (e) {
            var new_url_path = e.params.data.id + window.location.pathname.split("/").pop();
            //alert("new_url_path " + new_url_path);
            window.location = new_url_path;
        });

        var youtube_element = document.getElementById("youtube_iframe");

        if(youtube_element && false){
            var youtube_video_id = youtube_element.src.split("embed/")[1].split("?")[0];
            var youtube_video_check_url = "https://i1.ytimg.com/vi/" + youtube_video_id + "/hqdefault.jpg"

            $.ajax({
                url: youtube_video_check_url,
                type: 'GET',
                beforeSend: function(request) {
                    request.setRequestHeader("Access-Control-Allow-Origin", true);
                },
                success: function(ytresponse, more, more2){
                    console.log(ytresponse);
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    console.log("ERROR: ", XMLHttpRequest);
                    report_broken_link(youtube_video_check_url)
                }
            });

            function report_broken_link(link){
                $.ajax({
                    url: "/api/report-broken-link",
                    type: 'GET',
                    success: function(ytresponse, more, more2){
                        console.log(ytresponse)
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown) {
                        console.log("ERROR: ", XMLHttpRequest);
                        //window.location = "/login";

                    }
                });
            }
        }

block head_tags
    title #{event_data.title}
    //facebook meta tags
    meta(property="og:title" content="Beeftracker - " + event_data.title)
    meta(property="og:description" content=event_data.description)
    meta(property="og:image" content=file_server_url_builder(file_server_url_prefix, "events", event_data.cover_image, "c_fill,g_face,h_150,w_150", "webp") )
    meta(property="og:url" content=page_url)
    meta(property="og:site_name" content="Beeftracker")
    meta(property="og:type" content="news")
    //twitter meta tags
    meta(property="twitter:title" content="Beeftracker - " + event_data.title)
    meta(property="twitter:description" content=event_data.description)
    meta(property="twitter:image" content=file_server_url_builder(file_server_url_prefix, "events", event_data.cover_image, "c_fill,g_face,h_150,w_150", "webp") )
    meta(name="twitter:card" content="summary_large_image")
    
append body
    - var main_graphic = {};
    
    - for(var i = 0; i < event_data.gallery_items.length; i++){
        - if(event_data.gallery_items[i].main_graphic){
            - main_graphic = event_data.gallery_items[i];
        - }
    - }
    
    - var letter_mapping = ["one", "two", "three", "four", "five" ]
    
    - var aggressor_index;
    - var target_index;
        
    - aggressor_index = event_data.aggressors.map(function(e){ return String(e._id) } ).indexOf(String(event_data.beef_chains[main_event_beef_chain_index].actors[0])) != -1 ? event_data.aggressors.map(function(e){ return String(e._id) } ).indexOf(String(event_data.beef_chains[main_event_beef_chain_index].actors[0])) : event_data.aggressors.map(function(e){ return String(e._id) } ).indexOf(String(event_data.beef_chains[main_event_beef_chain_index].actors[1]))
    - target_index = event_data.targets.map(function(e){ return String(e._id) } ).indexOf(String(event_data.beef_chains[main_event_beef_chain_index].actors[0])) != -1 ? event_data.targets.map(function(e){ return String(e._id) } ).indexOf(String(event_data.beef_chains[main_event_beef_chain_index].actors[0])) : event_data.targets.map(function(e){ return String(e._id) } ).indexOf(String(event_data.beef_chains[main_event_beef_chain_index].actors[1]))
    
    div.bt-content-full-width.beef-background-banner(style="background-image: url('" + file_server_url_builder(file_server_url_prefix, "events", event_data.cover_image, "c_fill,g_face,h_150,w_150", "webp") + "')")

    div.bt-content.bt-content-shift-up
        
        div.beef-content(class="beef-category-#{event_data.categories[0].name.toLowerCase()}")
            div.beef-content-header
                div.beef-title
                    h1
                        | #{event_data.title}
                        span.beefometer.medium(class=letter_mapping[event_data.rating - 1] + "-beefs")
                div.beef-content-category
                    span.category-name #{event_data.categories[0].name}
                div.beef-content-contribute
                    a.btn.btn-primary.add-beef-button(href="/add-beef") Contribute
            
            div.beef-content-container
                div.col-md-12.beef-summary

                    form(action="/api/report-broken-link",method="POST")
                        div.main-graphic-undertext
                            input(type="submit",value="Is the media below broken? Report it here with a single click!")

                    - if(main_graphic.media_type == "soundcloud_embed")
                        div.beef-body-content-soundcloud
                            iframe(height="300", scrolling="no", frameborder="no", allow="autoplay", src=main_graphic.link)
                    - else if(main_graphic.media_type == "youtube_embed")
                        div.beef-body-content-youtube-video
                            iframe(id="youtube_iframe", height="315", scrolling="no", frameborder="no", src=main_graphic.link, allow="autoplay; encrypted-media")
                            //iframe(id="youtube_iframe", height="315", scrolling="no", frameborder="no", onerror="handle_youtube_error", src="https://www.youtube.com/embed/VmwOMtkDxtk", allow="autoplay; encrypted-media")
                    - else if(main_graphic.media_type == "image")
                        div.row.col-md-6(style="margin: 0 auto;")
                            div.beef-body-content-image.col-md-12
                                img(src=file_server_url_builder(file_server_url_prefix, "events", main_graphic.link, "", "webp")).float-left.col-sm-12
                    - else if(main_graphic.media_type == "video_embed")
                        div.beef-body-content-video
                            iframe(scrolling="no" src=main_graphic.link frameborder="0" allowtransparency="true")

                    //div.beef-thumb
                        img(src=server_url_prefix_with_image_formatting + "/events/" + event_data.img_title_fullsize).float-left
                        div.beef-content-thumb-border   
                    - if(!disable_voting){
                        +voting-panel()
                    - }

                    p.beef-description #{event_data.description}
                    
                    - if(related_events.length > 0){
                        +related-beefs(related_events, "events", "c_fill,g_face,h_120,w_120", event_data._id)
                    - }
                    
        +adsense-banner-ad()
        
        div.row.versus-panel
            div.col-5.beefer
                div
                    h4 #{event_data.aggressors[aggressor_index].name}
                    a(href="/actor/" + event_data.aggressors[aggressor_index]._id)
                        img(src=file_server_url_builder(file_server_url_prefix, "actors", event_data.aggressors[aggressor_index].img_title_fullsize, "c_fill,g_face,h_150,w_150", "webp")).actor-avatar

            div.col-2.versus
                h4 VS.
            div.col-5.beefee
                div
                    h4 #{event_data.targets[target_index].name}
                    a(href="/actor/" + event_data.targets[target_index]._id)
                        img(src=file_server_url_builder(file_server_url_prefix, "actors", event_data.targets[target_index].img_title_fullsize, "c_fill,g_face,h_150,w_150", "webp")).actor-avatar
        
        div.row(style="text-align:center")
            div.col-md-4.offset-md-4
                select.form-control.also-appears-in-select
                    option
                    each aggressor in event_data.aggressors
                        each target in event_data.targets                        
                            - if(!(String(aggressor._id) == String(event_data.aggressors[aggressor_index]._id) && String(target._id) == String(event_data.targets[target_index]._id))){ //-make sure neither the main aggressor or main target  are in the drop down
                                
                                - var beef_chain_id;
                                
                                - for(var i = 0; i < event_data.beef_chain_ids.length; i++){
                                                                
                                    - if(event_data.beef_chains[i].actors.map(function(e){ return String(e) }).indexOf(String(aggressor._id)) != -1 && event_data.beef_chains[i].actors.map(function(e){ return String(e) }).indexOf(String(target._id)) != -1){
                                        - beef_chain_id = event_data.beef_chain_ids[i];
                                        - break;
                                    - }
                                - }
                                
                                option(image_src=file_server_url_builder(file_server_url_prefix, "events", event_data.cover_image, "c_fill,g_face,h_150,w_150", "webp"), value="/beef/" + beef_chain_id + "/") #{aggressor.name} v. #{target.name}
                            - }
                        
        div.row
            +timeline-section(event_data, main_event_beef_chain_index)
            div.col-md-12.small_cta
                h3 See something missing? 
                    a(href="/add-beef") Add a new event 
                    | now!
               
        div.row
        
            +section('DATA', 'SOURCES', 'fa fa-book')
                ul
                    each data_source in event_data.data_sources
                        - if(!data_source.startsWith("http")){ data_source = "http://" + data_source; }
                        li
                            a(href=data_source, target="_blank") #{data_source}
               
        div.row
            +section('G', 'ALLERY', 'fa fa-file-image')
                +masonry-gallery-section(event_data.gallery_items, "events")
            +adsense-banner-ad()
            +comment-box-section(comment_data, "event")


